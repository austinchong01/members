<!-- views/index.ejs -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Members Only Club</title>
    <link rel="stylesheet" href="/styles/main.css">
  </head>
  <body>
    <div class="container">
      <% if (user) {%>
        <header class="welcome-header">
          <h1>Welcome Back, <%= user.first_name %> <%= user.last_name %>!</h1>
          <div class="user-info">
            <p><strong>Email:</strong> <%= user.email %></p>
            <p><strong>Status:</strong> 
              <span class="<%= user.is_member ? 'member' : 'non-member' %>">
                <%= user.is_member ? 'Member' : 'Non-Member' %>
              </span>
              <% if (user.is_admin) { %>
                <span class="admin-badge">Admin</span>
              <% } %>
            </p>
          </div>
          <a href="/auth/logout" class="btn btn-secondary">Log Out</a>
        </header>
        
        <!-- Success/Error messages -->
        <% if (typeof query !== 'undefined' && query.membership === 'success') { %>
          <div class="success-container">
            <div class="success-message">
              🎉 Congratulations! You are now a member of the exclusive club!
            </div>
          </div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.message === 'created') { %>
          <div class="success-container">
            <div class="success-message">
              ✅ Your message has been posted successfully!
            </div>
          </div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.message === 'deleted') { %>
          <div class="success-container">
            <div class="success-message">
              🗑️ Message has been deleted successfully!
            </div>
          </div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.error === 'delete_failed') { %>
          <div class="error-container">
            <div class="error-message">
              ❌ Failed to delete message. Please try again.
            </div>
          </div>
        <% } %>
        
        <main class="dashboard">
          <div class="dashboard-header">
            <h2>Dashboard</h2>
            <a href="/messages/new" class="btn btn-primary">Create New Message</a>
          </div>
          
          <!-- Messages Section -->
          <div class="messages-section">
            <h3>Community Messages</h3>
            <% if (messages && messages.length > 0) { %>
              <div class="messages-container">
                <% messages.forEach(message => { %>
                  <article class="message-card" data-message-id="<%= message.id %>">
                    <header class="message-header">
                      <div class="message-title-row">
                        <h4 class="message-title"><%= message.title %></h4>
                        <% if (user.is_admin) { %>
                          <form method="POST" action="/messages/<%= message.id %>/delete" style="display: inline;" onsubmit="return confirmDelete(event, <%= message.id %>)">
                            <button type="submit" class="btn-delete" title="Delete Message">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </form>
                        <% } %>
                      </div>
                      <div class="message-meta">
                        <% if (user.is_member) { %>
                          <!-- Members can see the author's name -->
                          <span class="message-author">
                            By: <strong><%= message.first_name %> <%= message.last_name %></strong>
                            <% if (message.author_is_member) { %>
                              <span class="member-badge">Member</span>
                            <% } %>
                            <% if (message.author_is_admin) { %>
                              <span class="admin-badge">Admin</span>
                            <% } %>
                          </span>
                        <% } else { %>
                          <!-- Non-members see "Anonymous" -->
                          <span class="message-author">By: <strong>Anonymous</strong></span>
                        <% } %>
                        <span class="message-date">
                          <%= new Date(message.created_at).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) %>
                        </span>
                      </div>
                    </header>
                    <div class="message-content">
                      <p><%= message.content %></p>
                    </div>
                  </article>
                <% }); %>
              </div>
            <% } else { %>
              <div class="no-messages">
                <p>No messages yet. <a href="/messages/new">Be the first to post!</a></p>
              </div>
            <% } %>
          </div>
          
          <% if (user.is_admin) { %>
            <div class="admin-content">
              <h3>🔒 Admin Panel</h3>
              <p>You have administrative privileges for this club.</p>
              <div class="admin-benefits">
                <h4>Your Admin Powers:</h4>
                <ul>
                  <li>🗑️ Delete any message</li>
                  <li>👀 See all user information</li>
                  <li>🛡️ Moderate community content</li>
                  <li>⚡ Full administrative access</li>
                </ul>
              </div>
            </div>
          <% } else if (user.is_member) { %>
            <div class="member-content">
              <h3>Member Area</h3>
              <p>Welcome to the exclusive member area!</p>
              <div class="member-benefits">
                <h4>Your Member Benefits:</h4>
                <ul>
                  <li>✅ See who wrote each story</li>
                  <li>✅ View posting dates and times</li>
                  <li>✅ Access to exclusive member discussions</li>
                  <li>✅ Priority support</li>
                </ul>
              </div>
            </div>
          <% } else { %>
            <div class="non-member-content">
              <h3>Become a Member</h3>
              <p>Join our exclusive club to access member-only content!</p>
              <div class="membership-benefits">
                <h4>Member Benefits:</h4>
                <ul>
                  <li>📝 See authors of all stories</li>
                  <li>📅 View exact posting dates and times</li>
                  <li>💬 Access exclusive discussions</li>
                  <li>🤝 Connect with other members</li>
                </ul>
              </div>
              <a href="/auth/membership-request" class="btn btn-primary">Request Membership</a>
            </div>
          <% } %>
        </main>
      <% } else { %>
        <div class="auth-container">
          <h1>Members Only Club</h1>
          <p class="subtitle">Please log in to access your account</p>
          
          <!-- Display errors if any -->
          <% if (locals.errors && errors.length > 0) { %>
            <div class="error-container">
              <ul class="error-list">
                <% errors.forEach(error => { %>
                  <li class="error-message"><%= error.msg %></li>
                <% }); %>
              </ul>
            </div>
          <% } %>
          
          <form action="/auth/login" method="POST" class="auth-form">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input
                id="email"
                name="email"
                placeholder="Enter your email"
                type="email"
                class="form-input"
                required
              />
            </div>
            
            <div class="form-group">
              <label for="password">Password</label>
              <input 
                id="password" 
                name="password" 
                type="password" 
                class="form-input"
                placeholder="Enter your password"
                required 
              />
            </div>
            
            <button type="submit" class="btn btn-primary btn-full">Log In</button>
          </form>
          
          <div class="auth-links">
            <p>Don't have an account? <a href="/auth/sign-up">Sign up here</a></p>
          </div>
        </div>
      <% } %>
    </div>

    <script>
      function confirmDelete(event, messageId) {
        event.preventDefault();
        
        if (confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
          // Find the message card and remove it immediately for better UX
          const messageCard = document.querySelector(`[data-message-id="${messageId}"]`);
          if (messageCard) {
            messageCard.style.opacity = '0.5';
            messageCard.style.pointerEvents = 'none';
          }
          
          // Submit the form
          event.target.submit();
          return true;
        }
        
        return false;
      }

      // Show success message and hide after 5 seconds
      document.addEventListener('DOMContentLoaded', function() {
        const successContainer = document.querySelector('.success-container');
        if (successContainer) {
          setTimeout(() => {
            successContainer.style.transition = 'opacity 0.5s ease-out';
            successContainer.style.opacity = '0';
            setTimeout(() => {
              successContainer.style.display = 'none';
            }, 500);
          }, 5000);
        }
      });
    </script>
    
    <style>
      /* Admin badge styles */
      .admin-badge {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        font-size: 0.75rem;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 0.5rem;
      }

      /* Admin content styles */
      .admin-content {
        margin-top: 2rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-radius: 12px;
        border-left: 4px solid #e74c3c;
      }

      .admin-content h3 {
        color: #c0392b;
        margin-bottom: 0.5rem;
      }

      .admin-benefits h4 {
        color: #c0392b;
        margin-bottom: 0.5rem;
      }

      .admin-benefits ul {
        margin: 0;
        padding-left: 1rem;
      }

      .admin-benefits li {
        margin-bottom: 0.25rem;
        color: #8b4513;
      }

      /* Delete button styles */
      .message-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
      }

      .btn-delete {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
      }

      .btn-delete:hover {
        background: #c0392b;
        transform: scale(1.1);
      }

      .btn-delete svg {
        width: 16px;
        height: 16px;
      }

      /* Message display styles */
      .messages-section {
        margin: 2rem 0;
      }

      .messages-section h3 {
        color: #2c3e50;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 0.5rem;
      }

      .messages-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .message-card {
        background: #fff;
        border: 1px solid #e1e8ed;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .message-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .message-header {
        margin-bottom: 1rem;
      }

      .message-title {
        color: #2c3e50;
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        line-height: 1.4;
        flex: 1;
      }

      .message-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .message-author {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .member-badge {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        font-size: 0.75rem;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .message-date {
        color: #95a5a6;
        font-size: 0.85rem;
      }

      .message-content {
        line-height: 1.6;
        color: #34495e;
      }

      .message-content p {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .no-messages {
        text-align: center;
        padding: 3rem 1rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px dashed #dee2e6;
      }

      .no-messages p {
        color: #6c757d;
        font-size: 1.1rem;
        margin: 0;
      }

      .no-messages a {
        color: #3498db;
        text-decoration: none;
        font-weight: 600;
      }

      .no-messages a:hover {
        text-decoration: underline;
      }

      /* Responsive design for message cards */
      @media (max-width: 768px) {
        .message-meta {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.25rem;
        }
        
        .message-card {
          padding: 1rem;
        }
        
        .message-title {
          font-size: 1.1rem;
        }

        .message-title-row {
          flex-direction: column;
          gap: 0.5rem;
        }

        .btn-delete {
          align-self: flex-end;
        }
      }
    </style>
  </body>
</html>